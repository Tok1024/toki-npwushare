# Toki Learning Hub 手动测试指南（按“功能链路”走一圈）

> 用来给你自己做手动回归，不是给用户看的文档。  
> 重点是：把你关心的几条核心链路（课程 / 资源 / 讨论 / 帖子 / 登录 / 审核 / 用户中心）一条一条走顺，顺便记录已知问题。

你日志里提到的几个大模块：

- 课程 + 资源上传/浏览/下载 + 讨论区 + 帖子（核心链路）
- 帖子互相评论、讨论区回复引用
- 用户登录、鉴权、受保护页面
- 审核界面（pending 资源/课程）【TODO】
- 用户中心【TODO，未来课程化】

下面的测试流程就是围绕这些模块设计的。

---

## 0. 前置准备（环境 + 种子数据）

这部分只要环境不变，一般做一次就够。

### 0.1 配置 `.env` 与依赖

1. `.env` 至少保证这些变量正确：

   ```bash
   KUN_DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:5432/toki?schema=public
   NEXT_PUBLIC_KUN_PATCH_ADDRESS_DEV=http://127.0.0.1:3000
   NEXT_PUBLIC_DISABLE_CAPTCHA=true
   REDIS_HOST=127.0.0.1
   REDIS_PORT=6379
   JWT_SECRET=please-change-me
   ```

2. 安装依赖：

   ```bash
   pnpm install
   ```

3. 确认 Postgres / Redis 在跑（docker 或本地服务均可）。

### 0.2 同步 Prisma schema + 填充种子数据

1. 同步 schema / 生成 client：

   ```bash
   pnpm prisma:generate
   pnpm prisma:push
   ```

2. 写入种子数据（大量学院 + 课程 + 资源 + 反馈）：

   ```bash
   pnpm run seed:courses
   ```

   这一步会：
   - 创建示例用户：`seed@example.com / alice@example.com / bob@example.com / carol@example.com`，密码都是 `123`。
   - 创建多个学院（包含你给的 1–15 院、`wgy`、`hc`、`intl` 等）。
   - 为每个学院生成若干课程，并自动填充资源 / 帖子 / 课程反馈 / 评论，用来做“大数据量”测试。

### 0.3 启动服务

```bash
pnpm dev
```

用浏览器访问：`http://127.0.0.1:3000`

---

## 1. 快速冒烟：首页 + 导航 + 登录

目标：5 分钟确认网站“活着”，再深挖功能。

1. 首页 `/`
   - Hero 区有蓝色渐变 + 「浏览课程 / 最新资源」按钮。
   - 有“关于 NWPUShare”的介绍卡片。
   - 有「热门课程」「最新课程资源」卡片列表（来自 seed 数据）。

2. 顶部导航
   - 「浏览课程」→ `/course` 打开课程索引页。
   - 「学院」→ `/department` 打开学院目录。
   - 「课程资源」→ `/resource`（课程资源库页）。
   - 「帮助」→ `/doc`（目前内容不多，至少 Header 正常）。
   - 「上传资源」→ `/edit/create`（未登录会被重定向到 `/login`）。

3. 登录
   - `/login` 用 `seed@example.com / 123` 登录。
   - 登录成功后右上角显示用户信息，刷新页面登录态保持。

只要这一步没问题，说明前端路由 + 后端 API + 登录链路基本通了，可以进功能链路测试。

---

## 2. 链路 A：课程索引页 `/course`（搜索 + 排序 + “只看有资源”）

目标：把课程索引页玩熟，它是所有课程流量的入口。

### 2.1 列表和布局

1. 打开 `/course`：
   - 顶部「浏览课程」标题 + 描述。
   - 中间有搜索框 + 三个排序按钮（最新 / 最热 / 难度）。
   - 下方是课程卡片网格（部门标签 + 课程名 + 资源/帖子/红心/难度）。
2. 窗口大小：
   - 小屏：1–2 列。
   - 大屏：3 列，与首页卡片风格对齐。

### 2.2 搜索

1. 在搜索框输入关键字：
   - 如「概率」「数字电路」「航空」。
   - 提交后 URL 带 `?q=xxx`，只看到匹配课程。
2. 清空搜索：
   - 删除关键字，提交空搜索，列表恢复全量。

### 2.3 排序：最新 / 最热 / 难度

1. 按顺序测试三个按钮：
   - 最新：默认排序 / `sort=latest` → 按创建时间倒序。
   - 最热：`sort=popular` → 按红心数倒序。
   - 难度：`sort=difficulty` → 按平均难度倒序。
2. 搭配搜索一起测：
   - 在有 `q=xxx` 时切换 `sort`，确认搜索关键字不会丢，列表顺序按预期变化。

### 2.4 “只看有资源”过滤（你提到的有 bug 这块）

如果你前端已经加了「只看有资源」开关（常见做法是 `hasResource=1`）：

1. 记下当前列表中某些 `resourceCount = 0` 的课程。
2. 打开“只看有资源”：
   - 理想行为：只显示 `resourceCount > 0` 的课程。
   - 实际行为：如果有不符合预期的课程（明明 0 资源却还在），记下名称和 URL，后面改代码时对照。

> 这块现在本身就是“待修”的地方，你的任务是通过测试把真实行为记录下来，而不是期待它已经完美。

---

## 3. 链路 B：完整课程闭环（浏览 → 资源 → 反馈 → 讨论）

这是你最关心的一条链路：  
**登录 → 进入课程 → 看资源 → 打开链接 → 留反馈 → 在讨论区说话**。

建议先挑一门 seed 里资源比较多的课程，比如计算机学院的“信号与系统”或“数据结构”，也可以随便选一个 `resourceCount > 0` 的课程。

### 3.1 进入课程详情页

1. 从 `/course` 找到一门 `resourceCount > 0` 的课程，点击进入 `/course/[dept]/[slug]`。
2. 检查顶部 Hero 卡片：
   - 学院 Chip。
   - 课程名。
   - 简短简介（如果 seed 有填）。
   - 右侧统计：资源数 / 帖子数 / 红心 / 难度。

### 3.2 课程信息 Tab

在「课程信息」Tab中确认：

- 开设学院名称正确。
- 课程代码（如果有）、授课教师、课程负责人显示正常。
- 标签以 Chip 或文本形式展示。
- 简介内容排版正常（没有挤成一团的小灰字）。

### 3.3 课程资源 Tab：浏览 + 打开资源

1. 打开「课程资源」Tab：
   - 顶部提示条：说明“只保存链接”等，用浅色卡片包起来。
   - 下方每条资源卡片包含：
     - 左边蓝色图标。
     - 中间：类型 Chip + 学期 + 发布时间 + 标题。
     - 一行“由 XXX 上传”（自动生成的用户名）。
     - 右侧一个按钮“打开资源”，如果有多个链接，下方有“还有 N 个链接”的提示。
2. 随机点几条“打开资源”：
   - 新标签页打开 `https://example.com/...` 或你自己填的链接。
   - 不要求资源本身真实可访问，只要跳转行为正常即可。

### 3.4 课程反馈 Tab：红心 + 难度 + 文本

1. 打开「课程反馈」Tab：
   - 上方两张统计卡片：
     - 累计红心：心形图标 + 计数。
     - 难度投票：平均难度 + 投票人数。
   - 右侧按钮：“提交反馈”或“更新我的反馈”。
2. 提交/更新反馈：
   - 点击按钮 → 弹出对话框。
   - 勾选 / 取消 “我喜欢这门课”。
   - 拖动难度到 3–4。
   - 写一句话（例如“测试反馈 1”）。
   - 点击提交：
     - 弹窗关闭。
     - 上方统计卡片更新。
     - 下方反馈列表出现你的卡片，展示头像、昵称、喜欢状态、难度、评论。
3. 再次打开弹窗修改：
   - 改变喜欢或难度，提交。
   - 验证统计和卡片都跟着变化。

### 3.5 讨论版 Tab：评论 + 回复 + 引用（这里你自己觉得 UI 丑但功能要测清楚）

1. 打开「讨论版」Tab：
   - 如果 seed 有课程评论，先看列表结构是否还能看懂（层级关系、时间顺序）。
2. 发一条新评论：
   - 输入“测试评论 1”，提交。
   - 刷新页面确认评论还在。
3. 回复一条已有评论：
   - 找一条父评论，点击回复（如果有）。
   - 输入“测试回复 1”，提交。
   - 刷新后观察：
     - 回复是否挂在正确父评论下面。
     - 引用内容（quoted 区块）是否对应正确那条评论——这一块你日志里说“有问题”，测试时刻意记一下具体错位表现，方便以后改。

> 这一块目前主要问题是“样式与首页不够统一 + 引用展示不够直观”；测试重点放在：能发评论、能回复、数据结构对不对，然后记录 UI 问题。

---

## 4. 链路 C：上传资源 `/edit/create` → 课程中查看

目标：从“上传表单”到“课程资源列表”打通，至少确认上传链路是通的。

### 4.1 未登录访问

1. 在未登录状态下访问 `/edit/create`：
   - 按理说会被中间件重定向到 `/login`。

### 4.2 登录后给已有课程上传资源

1. 登录 `seed@example.com / 123`。
2. 访问 `/edit/create`：
   - 选择一个已有学院（例如“10 计算机学院”或 seed 中的 `cs`）。
   - 选择其中一门已有课程。
   - 填写：
     - 标题：`测试资源 A`。
     - 类型：任意（如 slides / note）。
     - 链接：填一个你自己能访问的链接，或者随便一个 `https://example.com/...`。
   - 提交，看是否：
     - 表单不报错。
     - 请求返回成功。
3. 跳到该课程详情页的「课程资源」Tab：
   - 如果你让上传 API 直接写 `status='published'`，可以在列表看到刚才的“测试资源 A”。
   - 如果上传仍用默认 `pending`，你可以用 Prisma Studio 或 SQL 查 `resource` 表确认记录存在。

### 4.3 上传到新课程（自动创建课程）

1. 仍在 `/edit/create`：
   - 选择一个学院（例如 1 航空学院）。
   - 在课程输入格输入一个不存在的新名字，例如“航空学院 测试课程 X”。
   - 填标题 / 类型 / 链接，提交。
2. 到 `/course` 页：
   - 搜索“航空 测试”之类，看看新课程是否出现在列表中。
   - 点进详情，看看课程信息和资源是否如预期。

---

## 5. 链路 D：帖子 + 讨论（当前实现程度）

> 这一块你自己也说“还需要优化”：目前项目有 `posts` 模型和帖子列表，但还没有完整的“发帖 + 帖内评论 + 富文本编辑器”体验。

目前能测的：

1. 在某门 seed 课程下看帖子列表（如果 `PostList` 已挂在某个 Tab，或未来你自己挂上）：
   - 确认列表能拉到种子贴的标题。
   - 点击能跳转到对应路由（如果还没有帖子详情页，这里会 404 / 未实现，记为 TODO）。
2. 在「讨论版」Tab：
   - 把它当作“课程级讨论”，“帖子级讨论”以后再做。

你可以在自己的 TODO 里写上：

- 帖子创建/编辑/删除 API。
- 帖子详情页（挂 Milkdown 编辑器和评论）。
- 手动测试链路：`发帖 → 查看 → 评论 → 回复`（等到实现时再补到这份文档里）。

---

## 6. 链路 E：登录 / 鉴权 / 受保护页面

目标：确认登录态和中间件行为正确。

### 6.1 登录 + 刷新

1. `/login` 用 `seed@example.com / 123` 登录。
2. 回到首页或 `/course`：
   - 顶部右侧显示用户头像/名字。
3. 刷新页面：
   - 登录状态仍然存在。

### 6.2 受保护路由

按 `middleware.ts`，以下前缀需要登录：

- `/admin/**`
- `/user/**`
- `/comment/**`
- `/edit/**`

测试：

- 未登录访问 `/edit/create` 或 `/user/1/resource`：
  - 应被重定向到 `/login`。
- 登录后访问：
  - `/edit/create` 可以打开上传表单。
  - `/user/[uid]/resource` 可以打开用户资源列表（虽然内容现在还偏 patch 风，但至少不报错）。

---

## 7. 链路 F：多用户交互 + 已知问题专项

目标：模拟真实多人使用，并刻意观察你日志里提到的 UI/功能问题。

### 7.1 多用户评论 / 反馈

1. 浏览器 A：登录 `seed@example.com`。
2. 浏览器 B（无痕）：登录 `alice@example.com`。

在同一门课程下：

- A 在讨论版发评论，刷新 B 看是否能看到。
- B 回复 A 的评论，刷新 A 看是否挂在正确位置。
- 两人分别在「课程反馈」Tab 提交 / 更新反馈，看统计卡片是否合理变化。

### 7.2 已知问题点（测试时重点看）

- `/course` 页“只看有资源”：
  - 期望：过滤掉所有 `resourceCount=0` 的课程。
  - 实际：如果不对，记录具体课程和筛选条件。
- 讨论版回复引用：
  - 查看回复引用的内容是否和被回复的评论一致，有没有错位。
- UI 统一性：
  - 讨论版和反馈区域的样式是否明显和首页/课程卡片风格不一致，适合作为后续 UI 重构的 TODO。

---

## 8. 重置测试数据 & 排错小技巧

### 8.1 重置数据

如果你想“重来一遍”：

1. 粗暴模式（不在意现有数据）：
   - 可以清空数据库 schema 后重新：
     ```bash
     pnpm prisma:push
     pnpm run seed:courses
     ```
   - 清空方式取决于你的 Postgres 使用习惯（如 `DROP SCHEMA public CASCADE; CREATE SCHEMA public;`），记得谨慎。
2. 温柔模式（只想恢复示例）：
   - 直接再跑一次：
     ```bash
     pnpm run seed:courses
     ```
   - 脚本会对已有课程/资源按标题 upsert / deleteMany + create，一定程度覆盖乱改的数据。

### 8.2 排错建议

- 浏览器 Network：
  - 看请求 URL 是否正确（`/api/course/**`、`/api/auth/**` 等）。
  - 状态码是否是 200，有没有返回错误字符串。
- 终端日志：
  - Prisma / TypeScript / 运行时错误都会在 dev server 里打印 stack trace。
- 对比 seed 行为：
  - 如果 seed 数据对应功能都正常，而你新改的部分不正常，优先怀疑你最近动过的那块代码。

---

有了这份“按功能链路”的测试指南，你每次大改 UI 或后端时，只要按模块跑一遍相关链路（而不是全站乱点），就能比较有信心地确认：  
至少课程 / 资源 / 反馈 / 讨论 / 上传 / 登录 这些核心体验没有被你手滑改坏。  
等审核界面、用户中心、帖子详情这些补完，我们可以再往这份文档里加一节“后台审核链路”和“用户中心链路”的测试步骤。\*\*\*
