# ğŸ” NWPUShare ç”¨æˆ·è®¤è¯ç³»ç»Ÿæ¶æ„

> è¯¦ç»†è¯´æ˜é¡¹ç›®çš„ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è®¤è¯æµç¨‹åŠæ•°æ®æµè½¬

## ğŸ“Š ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯ (Browser)                           â”‚
â”‚                   - Cookies (httpOnly)                           â”‚
â”‚                   - Zustand Store (ç”¨æˆ·çŠ¶æ€)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Next.js API Routes (Backend)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  /auth/*     â”‚  â”‚  middleware  â”‚  â”‚  /api/*      â”‚          â”‚
â”‚  â”‚  (è®¤è¯è·¯ç”±)   â”‚  â”‚  (é‰´æƒä¸­é—´ä»¶) â”‚  â”‚  (ä¸šåŠ¡è·¯ç”±)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    PostgreSQL       â”‚              â”‚       Redis         â”‚
â”‚   (Prisma ORM)      â”‚              â”‚   (ç¼“å­˜ + ä¸´æ—¶æ•°æ®)  â”‚
â”‚                     â”‚              â”‚                     â”‚
â”‚ â€¢ ç”¨æˆ·åŸºæœ¬ä¿¡æ¯       â”‚              â”‚ â€¢ JWT Token         â”‚
â”‚ â€¢ å¯†ç å“ˆå¸Œ          â”‚              â”‚ â€¢ é‚®ä»¶éªŒè¯ç          â”‚
â”‚ â€¢ 2FA å¯†é’¥          â”‚              â”‚ â€¢ é™æµè®¡æ•°å™¨         â”‚
â”‚ â€¢ ç”¨æˆ·æƒé™è§’è‰²      â”‚              â”‚ â€¢ 2FA ä¸´æ—¶ä»¤ç‰Œ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å®Œæ•´è®¤è¯æµç¨‹

### 1ï¸âƒ£ ç”¨æˆ·æ³¨å†Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è®¿é—®  â”‚
â”‚ /register â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: è¯·æ±‚é‚®ç®±éªŒè¯ç                                         â”‚
â”‚ POST /api/auth/send-code                                    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“§ é‚®ä»¶æœåŠ¡å¤„ç†                                               â”‚
â”‚                                                             â”‚
â”‚ 1. æ£€æŸ¥é™æµ:                                                 â”‚
â”‚    - Redis: limit:email:{email}  (60s å†…ä¸èƒ½é‡å¤)           â”‚
â”‚    - Redis: limit:ip:{ip}        (60s å†…ä¸èƒ½é‡å¤)           â”‚
â”‚                                                             â”‚
â”‚ 2. ç”Ÿæˆ 7 ä½éšæœºéªŒè¯ç                                         â”‚
â”‚                                                             â”‚
â”‚ 3. å­˜å…¥ Redis:                                              â”‚
â”‚    Key: toki:nwpushare:{email}                             â”‚
â”‚    Value: éªŒè¯ç                                             â”‚
â”‚    TTL: 600s (10åˆ†é’Ÿ)                                       â”‚
â”‚                                                             â”‚
â”‚ 4. å‘é€é‚®ä»¶ (SMTP)                                          â”‚
â”‚    ä½¿ç”¨æ¨¡æ¿: verify-templates.ts                            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: ç”¨æˆ·æäº¤æ³¨å†Œä¿¡æ¯                                      â”‚
â”‚ POST /api/auth/register                                     â”‚
â”‚                                                             â”‚
â”‚ è¯·æ±‚ä½“:                                                      â”‚
â”‚ {                                                           â”‚
â”‚   name: "ç”¨æˆ·å",                                            â”‚
â”‚   email: "user@example.com",                               â”‚
â”‚   password: "å¯†ç ",                                          â”‚
â”‚   code: "éªŒè¯ç "                                             â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” éªŒè¯æµç¨‹                                                   â”‚
â”‚                                                             â”‚
â”‚ 1. éªŒè¯é‚®ç®±éªŒè¯ç :                                            â”‚
â”‚    - ä» Redis è¯»å–: toki:nwpushare:{email}                  â”‚
â”‚    - æ¯”å¯¹ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç                                       â”‚
â”‚    - éªŒè¯é€šè¿‡åè‡ªåŠ¨è¿‡æœŸåˆ é™¤                                    â”‚
â”‚                                                             â”‚
â”‚ 2. æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§:                                          â”‚
â”‚    - PostgreSQL: SELECT * FROM user                         â”‚
â”‚      WHERE LOWER(name) = LOWER(input.name)                 â”‚
â”‚                                                             â”‚
â”‚ 3. æ£€æŸ¥é‚®ç®±å”¯ä¸€æ€§:                                            â”‚
â”‚    - PostgreSQL: SELECT * FROM user                         â”‚
â”‚      WHERE LOWER(email) = LOWER(input.email)               â”‚
â”‚                                                             â”‚
â”‚ 4. å¯†ç å“ˆå¸ŒåŒ–:                                               â”‚
â”‚    - ä½¿ç”¨ bcrypt                                            â”‚
â”‚    - è‡ªåŠ¨åŠ ç› (salt rounds = 10)                            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¾ åˆ›å»ºç”¨æˆ·è®°å½•                                               â”‚
â”‚                                                             â”‚
â”‚ PostgreSQL - user è¡¨æ’å…¥:                                    â”‚
â”‚ {                                                           â”‚
â”‚   name: "ç”¨æˆ·å",                                            â”‚
â”‚   email: "é‚®ç®±",                                             â”‚
â”‚   password: "å“ˆå¸Œåçš„å¯†ç ",                                   â”‚
â”‚   ip: "æ³¨å†ŒIP",                                              â”‚
â”‚   role: 1,              // æ™®é€šç”¨æˆ·                          â”‚
â”‚   status: 1,            // æ­£å¸¸çŠ¶æ€                          â”‚
â”‚   created_at: NOW(),                                        â”‚
â”‚   updated_at: NOW()                                         â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ« ç”Ÿæˆ JWT Token                                            â”‚
â”‚                                                             â”‚
â”‚ 1. ç”Ÿæˆ JWT Payload:                                        â”‚
â”‚    {                                                        â”‚
â”‚      iss: "nwpushare",          // ç­¾å‘è€…                    â”‚
â”‚      aud: "nwpushare_users",    // å—ä¼—                     â”‚
â”‚      uid: ç”¨æˆ·ID,                                            â”‚
â”‚      name: "ç”¨æˆ·å",                                         â”‚
â”‚      role: 1,                    // è§’è‰²                     â”‚
â”‚      exp: 30å¤©å                                             â”‚
â”‚    }                                                        â”‚
â”‚                                                             â”‚
â”‚ 2. ä½¿ç”¨ JWT_SECRET ç­¾å                                      â”‚
â”‚                                                             â”‚
â”‚ 3. åŒé‡å­˜å‚¨ç­–ç•¥:                                              â”‚
â”‚    a) å­˜å…¥ Cookie:                                          â”‚
â”‚       Name: toki-nwpushare-access-token                    â”‚
â”‚       Value: JWT Token                                     â”‚
â”‚       Options: {                                           â”‚
â”‚         httpOnly: true,        // é˜²æ­¢ XSS                  â”‚
â”‚         sameSite: 'strict',    // é˜²æ­¢ CSRF                 â”‚
â”‚         maxAge: 30å¤©                                        â”‚
â”‚       }                                                     â”‚
â”‚                                                             â”‚
â”‚    b) å­˜å…¥ Redis (ç”¨äºéªŒè¯):                                 â”‚
â”‚       Key: toki:nwpushare:access:token:{uid}               â”‚
â”‚       Value: JWT Token                                     â”‚
â”‚       TTL: 30å¤©                                             â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… è¿”å›ç”¨æˆ·çŠ¶æ€                                               â”‚
â”‚                                                             â”‚
â”‚ Response:                                                   â”‚
â”‚ {                                                           â”‚
â”‚   uid: 1,                                                   â”‚
â”‚   name: "ç”¨æˆ·å",                                            â”‚
â”‚   avatar: "/default-avatar.webp",                          â”‚
â”‚   bio: "è¿™åªç¬¨èè‰è¿˜æ²¡æœ‰ç­¾å",                                 â”‚
â”‚   moemoepoint: 0,                                          â”‚
â”‚   role: 1,                                                  â”‚
â”‚   dailyCheckIn: 0,                                         â”‚
â”‚   dailyImageLimit: 0,                                      â”‚
â”‚   dailyUploadLimit: 0,                                     â”‚
â”‚   enableEmailNotice: true,                                 â”‚
â”‚   ...redirectConfig                                        â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ + Set-Cookie Header                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2ï¸âƒ£ ç”¨æˆ·ç™»å½•æµç¨‹

#### æ™®é€šç™»å½•ï¼ˆæ—  2FAï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è®¿é—®  â”‚
â”‚  /login   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æäº¤ç™»å½•ä¿¡æ¯                                          â”‚
â”‚ POST /api/auth/login                                        â”‚
â”‚                                                             â”‚
â”‚ è¯·æ±‚ä½“:                                                      â”‚
â”‚ {                                                           â”‚
â”‚   name: "ç”¨æˆ·åæˆ–é‚®ç®±",                                       â”‚
â”‚   password: "å¯†ç ",                                          â”‚
â”‚   captcha: "äººæœºéªŒè¯ç "  (å¯é€‰,ç›®å‰å…³é—­)                      â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” éªŒè¯æµç¨‹                                                   â”‚
â”‚                                                             â”‚
â”‚ 1. æŸ¥æ‰¾ç”¨æˆ· (æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•):                            â”‚
â”‚    PostgreSQL Query:                                        â”‚
â”‚    SELECT * FROM user                                       â”‚
â”‚    WHERE LOWER(name) = ? OR LOWER(email) = ?               â”‚
â”‚                                                             â”‚
â”‚ 2. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€:                                              â”‚
â”‚    - status = 1: æ­£å¸¸                                        â”‚
â”‚    - status = 2: å°ç¦ â†’ è¿”å›é”™è¯¯                             â”‚
â”‚                                                             â”‚
â”‚ 3. éªŒè¯å¯†ç :                                                  â”‚
â”‚    - ä½¿ç”¨ bcrypt.compare()                                  â”‚
â”‚    - æ¯”å¯¹è¾“å…¥å¯†ç ä¸æ•°æ®åº“ä¸­çš„å“ˆå¸Œ                              â”‚
â”‚                                                             â”‚
â”‚ 4. æ£€æŸ¥æ˜¯å¦å¯ç”¨ 2FA:                                          â”‚
â”‚    - user.enable_2fa === true  â†’ è¿›å…¥ 2FA æµç¨‹              â”‚
â”‚    - user.enable_2fa === false â†’ ç»§ç»­æ™®é€šç™»å½•                â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ« ç”Ÿæˆ JWT Token (åŒæ³¨å†Œæµç¨‹)                               â”‚
â”‚                                                             â”‚
â”‚ 1. ç”Ÿæˆ JWT                                                 â”‚
â”‚ 2. å­˜å…¥ Cookie: toki-nwpushare-access-token                â”‚
â”‚ 3. å­˜å…¥ Redis: access:token:{uid}                          â”‚
â”‚ 4. è¿”å›ç”¨æˆ·çŠ¶æ€                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2FA ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å¯ç”¨äº† 2FA                                                â”‚
â”‚ user.enable_2fa === true                                    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ç”Ÿæˆä¸´æ—¶ 2FA Token                                   â”‚
â”‚                                                             â”‚
â”‚ 1. ç”Ÿæˆæ— çŠ¶æ€ JWT (ä¸å­˜å…¥ Redis):                            â”‚
â”‚    Payload: {                                               â”‚
â”‚      id: user.id,                                           â”‚
â”‚      require2FA: true                                       â”‚
â”‚    }                                                        â”‚
â”‚    æœ‰æ•ˆæœŸ: 10 åˆ†é’Ÿ                                            â”‚
â”‚                                                             â”‚
â”‚ 2. å­˜å…¥ Cookie:                                             â”‚
â”‚    Name: kun-galgame-patch-moe-2fa-token                   â”‚
â”‚    Value: ä¸´æ—¶ Token                                        â”‚
â”‚    maxAge: 10 åˆ†é’Ÿ                                          â”‚
â”‚                                                             â”‚
â”‚ 3. è¿”å›æç¤ºä¿¡æ¯:                                              â”‚
â”‚    {                                                        â”‚
â”‚      require2FA: true,                                     â”‚
â”‚      id: user.id,                                           â”‚
â”‚      name: user.name,                                       â”‚
â”‚      avatar: user.avatar                                    â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: å‰ç«¯è·³è½¬åˆ° 2FA éªŒè¯é¡µé¢                               â”‚
â”‚ /login?2fa=true                                            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: ç”¨æˆ·è¾“å…¥ 2FA éªŒè¯ç                                    â”‚
â”‚ POST /api/auth/verify-2fa                                  â”‚
â”‚                                                             â”‚
â”‚ è¯·æ±‚ä½“:                                                      â”‚
â”‚ {                                                           â”‚
â”‚   token: "123456",          // 6ä½ TOTP ç                   â”‚
â”‚   isBackupCode: false       // æ˜¯å¦ä½¿ç”¨å¤‡ç”¨ç                 â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ Cookie:                                                     â”‚
â”‚   kun-galgame-patch-moe-2fa-token                          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” 2FA éªŒè¯æµç¨‹                                               â”‚
â”‚                                                             â”‚
â”‚ 1. éªŒè¯ä¸´æ—¶ Token:                                           â”‚
â”‚    - ä» Cookie è¯»å– 2FA Token                               â”‚
â”‚    - JWT è§£ç éªŒè¯ç­¾å                                        â”‚
â”‚    - æ£€æŸ¥æ˜¯å¦è¿‡æœŸ (10åˆ†é’Ÿ)                                    â”‚
â”‚                                                             â”‚
â”‚ 2. æŸ¥è¯¢ç”¨æˆ· 2FA é…ç½®:                                         â”‚
â”‚    PostgreSQL:                                              â”‚
â”‚    SELECT two_factor_secret, two_factor_backup             â”‚
â”‚    FROM user WHERE id = ?                                   â”‚
â”‚                                                             â”‚
â”‚ 3. éªŒè¯ 2FA ç :                                              â”‚
â”‚                                                             â”‚
â”‚    A. TOTP éªŒè¯ (æ—¶é—´åŠ¨æ€ç ):                                â”‚
â”‚       - ä½¿ç”¨ time2fa åº“                                      â”‚
â”‚       - éªŒè¯è¾“å…¥çš„ 6 ä½æ•°å­—                                   â”‚
â”‚       - åŸºäºæ—¶é—´çª—å£éªŒè¯ (Â±30ç§’)                              â”‚
â”‚                                                             â”‚
â”‚    B. å¤‡ç”¨ç éªŒè¯:                                             â”‚
â”‚       - æ£€æŸ¥ two_factor_backup æ•°ç»„                          â”‚
â”‚       - å¦‚æœåŒ¹é…,ä»æ•°ç»„ä¸­åˆ é™¤è¯¥ç                               â”‚
â”‚       - æ›´æ–°æ•°æ®åº“ (å¤‡ç”¨ç ä¸€æ¬¡æ€§ä½¿ç”¨)                          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… éªŒè¯æˆåŠŸ                                                   â”‚
â”‚                                                             â”‚
â”‚ 1. åˆ é™¤ä¸´æ—¶ Cookie:                                          â”‚
â”‚    cookie.delete('kun-galgame-patch-moe-temp-token')       â”‚
â”‚                                                             â”‚
â”‚ 2. ç”Ÿæˆæ­£å¼ JWT Token:                                       â”‚
â”‚    - å­˜å…¥ Cookie: toki-nwpushare-access-token              â”‚
â”‚    - å­˜å…¥ Redis: access:token:{uid}                        â”‚
â”‚    - æœ‰æ•ˆæœŸ: 30å¤©                                            â”‚
â”‚                                                             â”‚
â”‚ 3. è¿”å›ç”¨æˆ·çŠ¶æ€                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3ï¸âƒ£ ç”¨æˆ·é‰´æƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¯·æ±‚å—ä¿æŠ¤çš„ API                                          â”‚
â”‚ GET /api/user/profile                                       â”‚
â”‚                                                             â”‚
â”‚ Cookie:                                                     â”‚
â”‚   toki-nwpushare-access-token=eyJhbGciOiJ...                â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Middleware æ‹¦æˆªè¯·æ±‚                                           â”‚
â”‚ middleware/_verifyHeaderCookie.ts                           â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” Token éªŒè¯æµç¨‹                                             â”‚
â”‚                                                             â”‚
â”‚ 1. ä» Cookie æå– Token:                                     â”‚
â”‚    const token = cookies['toki-nwpushare-access-token']    â”‚
â”‚                                                             â”‚
â”‚ 2. JWT ç­¾åéªŒè¯:                                             â”‚
â”‚    - jwt.verify(token, JWT_SECRET)                         â”‚
â”‚    - éªŒè¯ç­¾åæœ‰æ•ˆæ€§                                           â”‚
â”‚    - éªŒè¯æœªè¿‡æœŸ                                              â”‚
â”‚    - æå– Payload                                           â”‚
â”‚                                                             â”‚
â”‚ 3. Redis äºŒæ¬¡éªŒè¯:                                           â”‚
â”‚    redisToken = getKv('access:token:{payload.uid}')       â”‚
â”‚    if (redisToken !== token) {                             â”‚
â”‚      return null  // Token å·²å¤±æ•ˆ                           â”‚
â”‚    }                                                        â”‚
â”‚                                                             â”‚
â”‚ 4. è¿”å›ç”¨æˆ·ä¿¡æ¯:                                              â”‚
â”‚    {                                                        â”‚
â”‚      iss: "nwpushare",                                     â”‚
â”‚      aud: "nwpushare_users",                               â”‚
â”‚      uid: 1,                                                â”‚
â”‚      name: "ç”¨æˆ·å",                                         â”‚
â”‚      role: 1                                                â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… é‰´æƒé€šè¿‡                                                   â”‚
â”‚                                                             â”‚
â”‚ ç»§ç»­å¤„ç†ä¸šåŠ¡é€»è¾‘...                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4ï¸âƒ£ ç”¨æˆ·ç™»å‡ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹å‡»ç™»å‡º                                                  â”‚
â”‚ POST /api/user/status/logout                               â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ—‘ï¸ æ¸…ç†è®¤è¯ä¿¡æ¯                                              â”‚
â”‚                                                             â”‚
â”‚ 1. åˆ é™¤ Redis Token:                                        â”‚
â”‚    delKv('access:token:{uid}')                             â”‚
â”‚                                                             â”‚
â”‚ 2. åˆ é™¤ Cookie:                                             â”‚
â”‚    cookie.delete('toki-nwpushare-access-token')            â”‚
â”‚                                                             â”‚
â”‚ 3. è¿”å›æˆåŠŸå“åº”                                              â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… ç™»å‡ºå®Œæˆ                                                   â”‚
â”‚                                                             â”‚
â”‚ å‰ç«¯æ¸…ç†æœ¬åœ°çŠ¶æ€:                                             â”‚
â”‚ - Zustand Store æ¸…ç©º                                        â”‚
â”‚ - è·³è½¬åˆ°ç™»å½•é¡µ                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ æ•°æ®å­˜å‚¨è¯¦è§£

### PostgreSQL (æ°¸ä¹…å­˜å‚¨)

**user è¡¨æ ¸å¿ƒå­—æ®µ:**

```sql
CREATE TABLE "user" (
  id                    SERIAL PRIMARY KEY,
  name                  VARCHAR(255) UNIQUE NOT NULL,
  email                 VARCHAR(255) UNIQUE NOT NULL,
  password              VARCHAR(255) NOT NULL,      -- bcrypt å“ˆå¸Œ
  avatar                TEXT,                        -- å¤´åƒ URL
  bio                   TEXT,                        -- ä¸ªäººç®€ä»‹
  role                  INTEGER DEFAULT 1,           -- 1: æ™®é€šç”¨æˆ·, 2: ç®¡ç†å‘˜
  status                INTEGER DEFAULT 1,           -- 1: æ­£å¸¸, 2: å°ç¦
  ip                    VARCHAR(255),                -- æ³¨å†Œ IP
  moemoepoint           INTEGER DEFAULT 0,           -- è´¡çŒ®å€¼
  daily_check_in        INTEGER DEFAULT 0,           -- ä»Šæ—¥ç­¾åˆ°æ ‡è®°
  daily_image_count     INTEGER DEFAULT 0,           -- ä»Šæ—¥ä¸Šä¼ å›¾ç‰‡æ•°
  daily_upload_size     BIGINT DEFAULT 0,            -- ä»Šæ—¥ä¸Šä¼ å¤§å°
  enable_email_notice   BOOLEAN DEFAULT TRUE,        -- é‚®ä»¶é€šçŸ¥å¼€å…³
  enable_2fa            BOOLEAN DEFAULT FALSE,       -- 2FA å¼€å…³
  two_factor_secret     VARCHAR(255),                -- 2FA å¯†é’¥
  two_factor_backup     TEXT[],                      -- 2FA å¤‡ç”¨ç æ•°ç»„
  created_at            TIMESTAMP DEFAULT NOW(),
  updated_at            TIMESTAMP DEFAULT NOW()
);
```

### Redis (ä¸´æ—¶å­˜å‚¨)

**Key å‘½åè§„èŒƒ:** `toki:nwpushare:{åŠŸèƒ½}:{æ ‡è¯†}`

| Key Pattern           | ç”¨é€”           | TTL  | æ•°æ®ç±»å‹ | ç¤ºä¾‹                                   |
| --------------------- | -------------- | ---- | -------- | -------------------------------------- |
| `{email}`             | é‚®ç®±éªŒè¯ç      | 600s | String   | `user@example.com` â†’ `"abc1234"`       |
| `limit:email:{email}` | é‚®ä»¶å‘é€é™æµ   | 60s  | String   | `limit:email:user@example.com` â†’ `"1"` |
| `limit:ip:{ip}`       | IP å‘é€é™æµ    | 60s  | String   | `limit:ip:127.0.0.1` â†’ `"1"`           |
| `access:token:{uid}`  | ç”¨æˆ· JWT Token | 30å¤© | String   | `access:token:1` â†’ `"eyJhbGci..."`     |

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. å¯†ç å®‰å…¨

```typescript
// æ³¨å†Œæ—¶å“ˆå¸Œ
import bcrypt from 'bcrypt'

// å“ˆå¸Œå¯†ç  (è‡ªåŠ¨åŠ ç›)
const hashedPassword = await bcrypt.hash(password, 10)

// éªŒè¯å¯†ç 
const isValid = await bcrypt.compare(inputPassword, hashedPassword)
```

**ç‰¹ç‚¹:**

- ä½¿ç”¨ bcrypt ç®—æ³•
- è‡ªåŠ¨åŠ ç› (salt rounds = 10)
- ä¸å¯é€†åŠ å¯†
- é˜²æ­¢å½©è™¹è¡¨æ”»å‡»

### 2. JWT åŒé‡éªŒè¯

**ä¸ºä»€ä¹ˆéœ€è¦åŒé‡éªŒè¯ï¼Ÿ**

```
Cookie ä¸­çš„ JWT        +        Redis ä¸­çš„ JWT
     (å®¢æˆ·ç«¯)                      (æœåŠ¡ç«¯)
        â”‚                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¿…é¡»åŒ¹é… â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹:
1. æ”¯æŒå¼ºåˆ¶ç™»å‡º (åˆ é™¤ Redis Token)
2. æ”¯æŒå•ç‚¹ç™»å½•æ§åˆ¶
3. é˜²æ­¢ Token æ³„éœ²åçš„æ— é™ä½¿ç”¨
4. å¯ä»¥å®æ—¶æ’¤é”€æƒé™
```

### 3. Cookie å®‰å…¨é…ç½®

```typescript
{
  httpOnly: true,        // é˜²æ­¢ XSS æ”»å‡» (JS æ— æ³•è¯»å–)
  sameSite: 'strict',    // é˜²æ­¢ CSRF æ”»å‡»
  secure: true,          // ä»… HTTPS ä¼ è¾“ (ç”Ÿäº§ç¯å¢ƒ)
  maxAge: 30 * 24 * 60 * 60 * 1000  // 30å¤©è¿‡æœŸ
}
```

### 4. é™æµæœºåˆ¶

```typescript
// é‚®ä»¶å‘é€é™æµ
await setKv(`limit:email:${email}`, '1', 60) // 60ç§’å†…ä¸èƒ½é‡å¤
await setKv(`limit:ip:${ip}`, '1', 60) // 60ç§’å†…ä¸èƒ½é‡å¤

// æ£€æŸ¥é™æµ
const limitEmail = await getKv(`limit:email:${email}`)
if (limitEmail) {
  return 'æ‚¨å‘é€é‚®ä»¶çš„é¢‘ç‡å¤ªå¿«äº†'
}
```

### 5. 2FA åŒå› ç´ è®¤è¯

**TOTP (Time-based One-Time Password):**

```typescript
import { Totp } from 'time2fa'

// éªŒè¯ 6 ä½åŠ¨æ€ç 
const isValid = Totp.validate({
  passcode: '123456',
  secret: user.two_factor_secret
})

// æ—¶é—´çª—å£: Â±30ç§’
// åŸºäºæ—¶é—´æˆ³ç”Ÿæˆ,æ¯30ç§’æ›´æ–°
```

**å¤‡ç”¨ç æœºåˆ¶:**

- ç”¨æˆ·å¯ç”¨ 2FA æ—¶ç”Ÿæˆ 10 ä¸ªå¤‡ç”¨ç 
- æ¯ä¸ªå¤‡ç”¨ç åªèƒ½ä½¿ç”¨ä¸€æ¬¡
- ä½¿ç”¨åä»æ•°æ®åº“åˆ é™¤
- ç”¨äºä¸¢å¤±éªŒè¯å™¨çš„åº”æ€¥æ¢å¤

---

## ğŸ“‹ å®Œæ•´æ•°æ®æµå›¾

```
ç”¨æˆ·æ³¨å†Œ/ç™»å½•
    â”‚
    â”œâ”€â†’ 1. å‘é€éªŒè¯ç 
    â”‚    â”‚
    â”‚    â”œâ”€â†’ ç”Ÿæˆéšæœºç 
    â”‚    â”œâ”€â†’ Redis: å­˜å‚¨éªŒè¯ç  (10åˆ†é’Ÿ)
    â”‚    â”œâ”€â†’ Redis: é™æµæ ‡è®° (60ç§’)
    â”‚    â””â”€â†’ SMTP: å‘é€é‚®ä»¶
    â”‚
    â”œâ”€â†’ 2. éªŒè¯ä¿¡æ¯
    â”‚    â”‚
    â”‚    â”œâ”€â†’ Redis: è¯»å–éªŒè¯ç éªŒè¯
    â”‚    â”œâ”€â†’ PostgreSQL: æ£€æŸ¥ç”¨æˆ·å”¯ä¸€æ€§
    â”‚    â””â”€â†’ bcrypt: å“ˆå¸Œå¯†ç 
    â”‚
    â”œâ”€â†’ 3. åˆ›å»ºç”¨æˆ·/éªŒè¯ç™»å½•
    â”‚    â”‚
    â”‚    â”œâ”€â†’ PostgreSQL: INSERT/SELECT user
    â”‚    â””â”€â†’ bcrypt: éªŒè¯å¯†ç å“ˆå¸Œ
    â”‚
    â”œâ”€â†’ 4. ç”Ÿæˆ Token
    â”‚    â”‚
    â”‚    â”œâ”€â†’ JWT: ç­¾åç”Ÿæˆ
    â”‚    â”œâ”€â†’ Cookie: å­˜å‚¨ Token (httpOnly)
    â”‚    â””â”€â†’ Redis: å­˜å‚¨ Token å‰¯æœ¬ (30å¤©)
    â”‚
    â””â”€â†’ 5. è¿”å›ç”¨æˆ·çŠ¶æ€
         â”‚
         â””â”€â†’ UserState: {uid, name, avatar, ...}

åç»­è¯·æ±‚
    â”‚
    â”œâ”€â†’ Middleware: æ‹¦æˆªè¯·æ±‚
    â”‚    â”‚
    â”‚    â”œâ”€â†’ Cookie: è¯»å– Token
    â”‚    â”œâ”€â†’ JWT: éªŒè¯ç­¾å
    â”‚    â”œâ”€â†’ Redis: äºŒæ¬¡éªŒè¯ Token
    â”‚    â””â”€â†’ æå–ç”¨æˆ·ä¿¡æ¯
    â”‚
    â””â”€â†’ ä¸šåŠ¡é€»è¾‘å¤„ç†

ç”¨æˆ·ç™»å‡º
    â”‚
    â”œâ”€â†’ Redis: åˆ é™¤ Token
    â”œâ”€â†’ Cookie: åˆ é™¤ Token
    â””â”€â†’ å‰ç«¯: æ¸…ç©ºçŠ¶æ€
```

---

## ğŸš€ å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½       | æ–‡ä»¶è·¯å¾„                                     |
| ---------- | -------------------------------------------- |
| æ³¨å†Œ API   | `app/api/auth/register/route.ts`             |
| ç™»å½• API   | `app/api/auth/login/route.ts`                |
| 2FA éªŒè¯   | `app/api/auth/verify-2fa/route.ts`           |
| JWT å·¥å…·   | `app/api/utils/jwt.ts`                       |
| å¯†ç åŠ å¯†   | `app/api/utils/algorithm.ts`                 |
| é‚®ä»¶å‘é€   | `app/api/utils/sendVerificationCodeEmail.ts` |
| éªŒè¯ç æ ¡éªŒ | `app/api/utils/verifyVerificationCode.ts`    |
| Redis å·¥å…· | `lib/redis.ts`                               |
| é‰´æƒä¸­é—´ä»¶ | `middleware/_verifyHeaderCookie.ts`          |
| ç”¨æˆ·çŠ¶æ€   | `store/userStore.ts`                         |
| æ•°æ®åº“æ¨¡å‹ | `prisma/schema/user.prisma`                  |

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

```env
# JWT é…ç½®
JWT_SECRET=your-super-secret-key-here
JWT_ISS=nwpushare
JWT_AUD=nwpushare_users

# Redis é…ç½®
REDIS_HOST=127.0.0.1
REDIS_PORT=6379

# PostgreSQL é…ç½®
DATABASE_URL=postgresql://user:password@localhost:5432/nwpushare

# é‚®ä»¶é…ç½®
KUN_VISUAL_NOVEL_EMAIL_HOST=smtp.gmail.com
KUN_VISUAL_NOVEL_EMAIL_PORT=587
KUN_VISUAL_NOVEL_EMAIL_ACCOUNT=your-email@gmail.com
KUN_VISUAL_NOVEL_EMAIL_PASSWORD=your-app-password
KUN_VISUAL_NOVEL_EMAIL_FROM=NWPUShare

# å¼€å‘ç¯å¢ƒé…ç½®
KUN_DISABLE_EMAIL=true              # ç¦ç”¨é‚®ä»¶å‘é€
KUN_VERIFICATION_CODE=dev-1234567   # å¼€å‘ç¯å¢ƒå›ºå®šéªŒè¯ç 
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒç‰¹ç‚¹

1. **åŒé‡éªŒè¯æœºåˆ¶**: JWT + Redis ä¿è¯å®‰å…¨æ€§å’Œå¯æ§æ€§
2. **å¤šå±‚å®‰å…¨é˜²æŠ¤**: bcrypt å¯†ç å“ˆå¸Œ + httpOnly Cookie + CSRF é˜²æŠ¤
3. **çµæ´»çš„è®¤è¯æ–¹å¼**: æ”¯æŒç”¨æˆ·å/é‚®ç®±ç™»å½• + å¯é€‰ 2FA
4. **å®Œå–„çš„é™æµæœºåˆ¶**: é‚®ä»¶å‘é€é™æµ + IP é™æµ
5. **é«˜æ•ˆçš„ç¼“å­˜ç­–ç•¥**: Redis å­˜å‚¨ä¸´æ—¶æ•°æ®,å‡è½»æ•°æ®åº“å‹åŠ›

### æ•°æ®æµå‘

```
æ³¨å†Œ/ç™»å½• â†’ éªŒè¯ â†’ PostgreSQL (æ°¸ä¹…å­˜å‚¨) â†’ ç”Ÿæˆ JWT
    â†“
Cookie (å®¢æˆ·ç«¯) + Redis (æœåŠ¡ç«¯ç¼“å­˜)
    â†“
åç»­è¯·æ±‚ â†’ Middleware éªŒè¯ â†’ JWT + Redis åŒé‡æ£€æŸ¥
    â†“
ä¸šåŠ¡é€»è¾‘å¤„ç†
```

### å®‰å…¨ä¿éšœ

- âœ… å¯†ç ä¸æ˜æ–‡å­˜å‚¨ (bcrypt å“ˆå¸Œ)
- âœ… Token åŒé‡éªŒè¯ (Cookie + Redis)
- âœ… XSS é˜²æŠ¤ (httpOnly Cookie)
- âœ… CSRF é˜²æŠ¤ (sameSite Cookie)
- âœ… é™æµä¿æŠ¤ (Redis è®¡æ•°å™¨)
- âœ… 2FA æ”¯æŒ (TOTP + å¤‡ç”¨ç )
- âœ… ä¼šè¯ç®¡ç† (å¯å¼ºåˆ¶ç™»å‡º)

---

_Generated with NWPUShare Auth System_
