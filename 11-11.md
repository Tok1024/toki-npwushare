# 2025-11-11 项目现状与指南

## 1. 当前进度概览
- **品牌重塑**：站点定位为「Toki Learning Hub」，主页 Hero、导航、资源类型、README 等均更新为学习场景描述。Galgame 区块已移除或迁出首屏。
- **课程域模型落地**：Prisma 拆分出 department / teacher / course / course_teacher / resource / post / comment / course_feedback / resource_rating 等表；`scripts/seedCourses.ts` 可注入示例学院/课程/资源，默认管理员 `seed@example.com / 123`。
- **课程详情页**：复用了 TouchGal 信息卡 + Tabs 结构，Tabs 包含「课程信息 / 课程资源 / 讨论版 / 课程反馈」，并以 `/api/course/**` 数据驱动。评论与红心/难度反馈 UI 已接通课程 API。
- **Legacy 归档**：所有补丁/Galgame 相关页面、API、Prisma 模型、脚本已放入 `archive/touchgal/**`，详见 `archive/README.md`，主仓库仅保留课程核心代码。
- **资源策略**：仅保存链接 (`resource.links String[]`)，上传者通过 `author_id` 关联 user；下载卡片复用补丁组件但不再触发补丁统计接口。
- **登录体验**：验证码与密码格式校验暂时关闭，仍会校验数据库哈希。`utils/kunFetch` 默认 fallback 到 `window.location.origin`，避免环境变量缺失导致登录/首页报错。
- **上传流程**：`components/course/upload/UploadResourceForm.tsx` 新增“学院 → 课程”双下拉，若课程缺失可即时创建，随后调用 `POST /api/course/[dept]/[slug]/resources` 并落库为 `pending`，后台审核后方可上线。

## 2. 数据模型（Prisma）
| 模型 | 说明 | 关键字段/关系 |
|---|---|---|
| `department` | 学院 / 开课单位 | `slug` 唯一，`courses`、`teachers` 关联 |
| `teacher` | 教师，选填学院 | 与 `course_teacher`、`resources`、`posts` 关联 |
| `course` | 课程（学院 + slug 组合唯一） | `tags`、`resource_count`、`post_count`、`ratings`、`course_teacher`、`comments` |
| `resource` | 课程资源，仅存外链 | `links String[]`、`author_id`、`teacher_id`、`term`、`status`、`visibility` |
| `post` | 课程经验帖/教程 | `author_id`、`teacher_id`、`term`、`comments` |
| `comment` | 评论（支持课程/资源/帖子） | `course_id`、`resource_id`、`post_id`、`parent_id`、`course_comment_like` |
| `course_feedback` | 课程反馈 | `liked`（红心）+ `difficulty`（1~5）+ 可选短评，聚合至 `course.heart_count/difficulty_avg` |
| `user` | 账号 | JWT 登录 + 2FA 字段；新增 `course_resource`、`course_feedback`、`course_comment_like` 等关联 |
> Prisma schema 拆分在 `prisma/schema/*.prisma`，入口配置 `prisma.config.ts`。

## 3. 架构与代码组织
- **前端**：Next.js App Router + HeroUI + Tailwind。Server Components（如 `app/course/[dept]/[slug]/page.tsx`）负责数据聚合，Client Components（`components/course/**/*`、`components/home/**/*`）负责交互。
- **API**：Route Handlers 位于 `app/api/**`，课程域以 `/api/course/...` 为前缀，仍保留 TouchGal 的 `/api/patch`、`/api/galgame` 等遗留端点（待清理）。
- **数据访问**：`prisma/index.ts` 暴露 Prisma Client；PostgreSQL 连接由 `KUN_DATABASE_URL` 控制。Redis 仅用于 JWT/登录状态缓存。
- **状态管理**：Zustand (`store/*`)，例如 `store/userStore.ts` 管理登录态、`store/searchStore.ts` 管理搜索过滤。
- **脚本**：`scripts/seedCourses.ts` 负责注入演示数据；部署脚本 `scripts/deploy*.ts` + `ecosystem.config.cjs`。
- **后台任务**：`server/tasks/*` 仍是 TouchGal 逻辑（每日清零/补丁同步），尚未替换。

## 4. 页面地图（主要路由）
| 路径 | 说明 | 关键组件 |
|---|---|---|
| `/` | 首页，展示 Hero + 站点介绍 + 最新课程 + 最新资源 | `components/home/*` |
| `/course/[dept]/[slug]` | 课程详情（信息/资源/讨论/反馈） | `components/course/Header.tsx` 及其 Tabs/评论/反馈子组件 |
| `/course` *(待实现)* | 课程索引（列表 + 搜索 + 筛选） | 计划复用 `HomeCourseSection` 逻辑 |
| `/department/[slug]` *(待实现)* | 学院视图，列出课程/教师/资源统计 | 待定义 |
| `/resource` | 旧补丁资源列表（尚未重写） | `components/resource/*` |
| `/login`、`/register`、`/auth/forgot` | 账号流程 | `components/login/*`, `components/register/*` |
| `/user/[id]/**` | 个人主页（资源/评论/收藏） | `components/user/*` |
| `/admin/**` | 旧后台菜单（Galgame 审核等） | `components/admin/*`（待替换或归档） |

## 5. API 映射（重点）
- **课程域**
  - `GET /api/course/list`
  - `GET /api/course/[dept]/[slug]`
  - `GET /api/course/[dept]/[slug]/resources`
  - `GET /api/course/[dept]/[slug]/posts`（仅读取，发布功能待接入）
  - `GET/POST/PUT/DELETE /api/course/[dept]/[slug]/comment`
  - `PUT /api/course/[dept]/[slug]/comment/like`
  - `GET/POST/PUT/DELETE /api/course/[dept]/[slug]/rating`
  - `PUT /api/course/[dept]/[slug]/rating/like`
- **公共/遗留**
  - `/api/home`、`/api/resource/latest`、`/api/galgame`、`/api/patch/**`、`/api/tag/**`、`/api/company/**`
- **账号/用户**
  - `/api/auth/login|register|verify-2fa|send-register-code|captcha`
  - `/api/user/status/**`、`/api/user/setting/**`
- **上传/工具**
  - `/api/upload/resource|video`、`/api/edit/**` 等仍是旧逻辑，未来可能重写为课程域专用接口。

## 6. 运维与启动指引
```bash
pnpm install
pnpm prisma:generate
pnpm prisma:push
pnpm run seed:courses    # 导入示例学院/课程/资源
pnpm dev
```
- 环境变量（示例）
  ```env
  KUN_DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:5432/toki?schema=public
  NEXT_PUBLIC_KUN_PATCH_ADDRESS_DEV=http://127.0.0.1:3000
  NEXT_PUBLIC_DISABLE_CAPTCHA=true
  REDIS_HOST=127.0.0.1
  REDIS_PORT=6379
  JWT_SECRET=please-change-me
  ```
  - Seed 管理员：`seed@example.com / 123`

## 7. 待办与风险
1. **TopBar 导航**：`components/kun/top-bar/*` 仍是 TouchGal 菜单，需要改成 “浏览课程 / 学院 / 帮助文档 / 上传资源 / 个人中心”。
2. **命名与模块**：`components/galgame`、`components/patch`、`constants/galgame.ts` 等旧模块亟需迁移或归档，以免混淆。
3. **课程索引与学院视图**：实现 `/course` 列表页和 `/department/[slug]` 概览页，并在导航中露出。
4. **资源发布与审核**：`resource.status` 已支持 `pending`，需新增创建接口 + 管理后台（pending → published/rejected），同时更新 `course.resource_count`。
5. **经验帖 Tab**：`post` 模型尚未接前端，需复用 Milkdown 编辑器实现 Markdown 发布/编辑/删除。
6. **登录安全**：Captcha 与密码格式校验已关闭，需要在梳理完体验后重新启用或用 BetterAuth 替换。
7. **后台任务**：`server/cron.ts` 仍在执行 TouchGal 任务（萌萌点重置等），需替换为课程域的统计或清理任务。
8. **残留 API / UI**：大量 `/api/patch/**`、`/api/galgame`、`/api/admin/**` 仍在运行，后续要么归档要么彻底删除，避免误用。
9. **自主迭代路线**：`docs/improvement-guide.md` 将“环境 → 页面 → API → 后台 → 部署”拆成 6 个阶段，可按表格逐步完成后续改造。

> 提示：若再次出现 `Failed to fetch`，请确认 `NEXT_PUBLIC_KUN_PATCH_ADDRESS_DEV` 与页面访问 host 一致；在浏览器端可 fallback 到 `window.location.origin`。

## 8. 资源上传流程（前后端协同）
1. **选择实体**：`UploadResourceForm` 通过 `/api/department/list` 加载学院与课程，左列选择学院，右列联动课程；若列表无匹配项，展开“新增课程”区域填写 `courseName` 与 `courseSlug`。
2. **字段校验**：表单使用 React Hook Form + Zod（`courseResourceCreateSchema` + 表单扩展）约束标题、类型、链接（1~20 条 URL）及学期、教师。
3. **提交动作**：前端 `kunFetchPost('/course/${dept}/${slug}/resources', payload)`，后端 Route Handler 自动 `upsert department / course`，赋予 `status=pending`、`visibility=public`，并记录 `author_id`。
4. **审核与展示**：`GET /api/course/[dept]/[slug]/resources` 仅返回 `published` 资源；管理员可在 `/admin` 审核后更新状态。待接入的资源列表需要在审核后刷新 `resource_count`。

## 9. 种子数据（`scripts/seedCourses.ts`）
- 账号：`seed/alice/bob/carol@example.com`（密码均为 `123`）；`seed-user` 角色为管理员，其余为普通用户。
- 学院：计算机、电子信息、数学统计三大节点，包含 7+ 位教师。
- 课程：信号与系统、数据结构、操作系统、数字电路、概率论与数理统计、线性代数等；每门课附带标签、授课教师记录 (`course_teacher`)。
- 内容：为每门课程写入多条资源（slides/note/exam/solution/link 等类型）、帖子（Markdown 文本）、课程评论与反馈，以及示例资源评论。
- 统计：种子脚本最后会回写 `resource_count`、`post_count`、`rating_count/avg`，便于首页和详情页直接展示。
